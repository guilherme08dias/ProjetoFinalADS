{% extends "base.html" %}

{% block title %}{{ 'Editar' if paciente else 'Novo' }} Paciente - DentalSystem{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="page-header">
        <div>
            <h1 class="page-title">{{ 'Editar' if paciente else 'Novo' }} Paciente</h1>
            <p class="page-subtitle">{{ 'Altere os dados do paciente' if paciente else 'Cadastre um novo paciente e
                entregue as credenciais' }}</p>
        </div>
        <div class="page-actions">
            <a href="{{ url_for('admin_pacientes') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i>
                Voltar
            </a>
        </div>
    </div>

    <div class="card" style="max-width: 600px;">
        <div class="card-header">
            <h3 class="card-title">
                <i class="bi bi-person" style="color: var(--color-primary);"></i>
                Dados do Paciente
            </h3>
        </div>
        <div class="card-body">
            <form method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group">
                    <label class="form-label" for="nome">Nome Completo *</label>
                    <input type="text" id="nome" name="nome" class="form-control"
                        placeholder="Nome completo do paciente" value="{{ paciente.nome if paciente else '' }}"
                        required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">E-mail (Login) *</label>
                    <input type="email" id="email" name="email" class="form-control" placeholder="email@exemplo.com"
                        value="{{ paciente.email if paciente else '' }}" {{ 'readonly' if paciente else '' }} required>
                    {% if paciente %}
                    <div class="form-hint">O email nao pode ser alterado</div>
                    {% else %}
                    <div class="form-hint">Este sera o login do paciente</div>
                    {% endif %}
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="telefone">Telefone</label>
                        <input type="tel" id="telefone" name="telefone" class="form-control"
                            placeholder="(00) 00000-0000" value="{{ paciente.telefone if paciente else '' }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cpf">CPF</label>
                        <input type="text" id="cpf" name="cpf" class="form-control" placeholder="000.000.000-00"
                            value="{{ paciente.cpf if paciente else '' }}" {{ 'readonly' if paciente else '' }}>
                        {% if paciente %}
                        <div class="form-hint">O CPF nao pode ser alterado</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="senha">{{ 'Nova Senha (deixe em branco para manter)' if paciente else
                        'Senha *' }}</label>
                    <input type="text" id="senha" name="senha" class="form-control" placeholder="Minimo 6 caracteres"
                        minlength="6" {{ 'required' if not paciente else '' }}>
                    {% if not paciente %}
                    <div class="form-hint">
                        <i class="bi bi-info-circle"></i>
                        Anote esta senha para entregar ao paciente!
                    </div>
                    {% else %}
                    <div class="form-hint">Preencha apenas se quiser alterar a senha</div>
                    {% endif %}
                </div>

                {% if paciente %}
                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" name="ativo" class="form-check-input" {{ 'checked' if paciente.ativo
                            else '' }}>
                        <span class="form-check-label">Paciente ativo</span>
                    </label>
                    <div class="form-hint">Pacientes inativos nao conseguem fazer login</div>
                </div>
                {% endif %}

                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="bi bi-check-lg"></i>
                    {{ 'Salvar Alteracoes' if paciente else 'Cadastrar Paciente' }}
                </button>
            </form>
        </div>
    </div>

    {% if not paciente %}
    <div class="card mt-4"
        style="max-width: 600px; background: rgba(0, 122, 255, 0.05); border-color: var(--color-primary);">
        <div class="card-body">
            <div style="display: flex; gap: 16px; align-items: flex-start;">
                <i class="bi bi-lightbulb" style="font-size: 24px; color: var(--color-primary);"></i>
                <div>
                    <h4 style="margin: 0 0 8px 0; font-size: 16px; color: var(--color-primary);">Dica Importante</h4>
                    <p style="margin: 0; font-size: 14px; color: var(--color-gray-700);">
                        Apos cadastrar o paciente, anote o <strong>email</strong> e a <strong>senha</strong> para
                        entregar a ele.
                        Isso evita erros de digitacao no cadastro e garante que os dados estejam corretos.
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Formatacao do telefone
    document.getElementById('telefone').addEventListener('input', function (e) {
        var value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);

        if (value.length > 6) {
            value = '(' + value.slice(0, 2) + ') ' + value.slice(2, 7) + '-' + value.slice(7);
        } else if (value.length > 2) {
            value = '(' + value.slice(0, 2) + ') ' + value.slice(2);
        } else if (value.length > 0) {
            value = '(' + value;
        }

        e.target.value = value;
    });

    // Formatacao do CPF (apenas para novo cadastro)
    var cpfField = document.getElementById('cpf');
    if (cpfField && !cpfField.readOnly) {
        cpfField.addEventListener('input', function (e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);

            if (value.length > 9) {
                value = value.slice(0, 3) + '.' + value.slice(3, 6) + '.' + value.slice(6, 9) + '-' + value.slice(9);
            } else if (value.length > 6) {
                value = value.slice(0, 3) + '.' + value.slice(3, 6) + '.' + value.slice(6);
            } else if (value.length > 3) {
                value = value.slice(0, 3) + '.' + value.slice(3);
            }

            e.target.value = value;
        });
    }
</script>
{% endblock %}